<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
html, body {
    font-family: -apple-system;
    width: 100%;
    height: 100%;
    margin: 0;
    font-size: 1em;
}

#droparea {
    margin-top: 1em;
    width: 100%;
    height: 200px;
    top: 0;
    left: 0;
}

textarea {
    width: 100%;
    height: calc(100% - 200px);
    font-family: monospace;
}
</style>

<div id="droparea">
    <div>To manually test, drop something into this area and observe the output below.</div>
</div>
<textarea id="textarea"></textarea>

<script>
    function getEntriesAsPromise(entry) {
        if (!entry.isDirectory)
            return Promise.resolve([]);

        return new Promise((resolve, reject) => {
            let result = [];
            let reader = entry.createReader();
            let doBatch = () => {
                reader.readEntries(entries => {
                    if (entries.length > 0) {
                        entries.forEach(e => result.push(e));
                        doBatch();
                    } else
                        resolve(result);
                }, reject);
            };
            doBatch();
        });
    }

    droparea.addEventListener("dragenter", event => event.preventDefault());
    droparea.addEventListener("dragover", event => event.preventDefault());
    droparea.addEventListener("drop", event => {
        logItemAndFileEntryInformation(event.dataTransfer.items);
        event.preventDefault();
    });

    async function fileFromFileSystemFileEntry(fileEntry)
    {
        return new Promise(resolve => fileEntry.file(file => resolve(file)));
    }

    async function representationForFileSystemEntry(entry)
    {
        let type = entry.isDirectory ? "DIR" : (entry.isFile ? "FILE" : "UNKNOWN");
        let representation = "";
        if (entry.isDirectory) {
            representation += `DIR: ${entry.fullPath}\n`;
            for (let child of await getEntriesAsPromise(entry))
                representation += await representationForFileSystemEntry(child);
        } else if (entry.isFile) {
            let file = await fileFromFileSystemFileEntry(entry);
            representation += `FILE: ${entry.fullPath} ('${file.type}', ${file.size} bytes)\n`;
        }
        return representation;
    }

    async function logItemAndFileEntryInformation(items)
    {
        textarea.value = "";
        for (let index = 0; index < items.length; index++) {
            let item = items.item(index);
            textarea.value += `Found data transfer item (kind: '${item.kind}', type: '${item.type}')\n`;
            let entry = item.webkitGetAsEntry();
            if (entry)
                textarea.value += await representationForFileSystemEntry(entry);
        }
    }
</script>
</html>
